{% extends 'base.html' %}
{% block title %}Dashboard - Procurement{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3">Recent Purchase Requests</h1>
  {% if current_user.role in ['admin', 'approver', 'requester'] %}
    <a class="btn btn-primary" href="{{ url_for('pr_new') }}">New PR</a>
  {% endif %}
</div>

<div class="list-group">
  {% for pr in prs %}
    <div class="list-group-item d-flex justify-content-between align-items-start">
      <div class="flex-grow-1">
        <a href="{{ url_for('pr_view', pr_id=pr.id) }}" class="text-decoration-none text-dark">
          <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{ pr.title }}</h5>
            <small>{{ pr.created_at.strftime('%Y-%m-%d') }}</small>
          </div>
          <p class="mb-1">Status:
            <span class="badge
              {% if pr.status == 'pending' %}bg-warning
              {% elif pr.status == 'approved' %}bg-success
              {% elif pr.status == 'rejected' %}bg-danger
              {% else %}bg-secondary{% endif %}">
              {{ pr.status }}
            </span>
          </p>
        </a>

        {% if current_user.role in ['admin', 'approver'] and pr.status == 'pending' %}
        <div class="mt-2 d-flex gap-2">
          <form method="POST" action="{{ url_for('pr_approve', pr_id=pr.id) }}">
            <input type="hidden" name="action" value="approve">
            <button type="submit" class="btn btn-success btn-sm">Approve</button>
          </form>
          <form method="POST" action="{{ url_for('pr_approve', pr_id=pr.id) }}">
            <input type="hidden" name="action" value="reject">
            <button type="submit" class="btn btn-danger btn-sm">Reject</button>
          </form>
        </div>
        {% endif %}
      </div>

      <!-- DELETE BUTTONS -->
      {% if current_user.role in ['admin', 'approver'] and pr.status != 'approved' %}
      <!-- Draft & Pending: approver and admin -->
      <form method="POST" action="{{ url_for('pr_delete', pr_id=pr.id) }}" onsubmit="return confirm('Are you sure you want to delete this PR?');">
        <button type="submit" class="btn btn-outline-danger btn-sm ms-3">ðŸ—‘</button>
      </form>
      {% elif current_user.role == 'admin' and pr.status == 'approved' %}
      <!-- Approved: only admin with password -->
      <button class="btn btn-outline-danger btn-sm ms-3 delete-pr-btn"
          data-pr-id="{{ pr.id }}"
          data-status="{{ pr.status }}"
          data-has-pos="{{ '1' if pr.purchase_orders else '0' }}">
    ðŸ—‘
      </button>
      {% endif %}
    </div>
  {% else %}
    <div class="alert alert-light">No PRs yet</div>
  {% endfor %}
</div>

<!-- Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="passwordDeleteForm" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="pr_id" id="modalPrId">
          <div class="mb-3">
            <label for="adminPassword" class="form-label">Enter Admin Password:</label>
            <input type="password" class="form-control" id="adminPassword" name="password" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.querySelectorAll('.delete-pr-btn').forEach(button => {
  button.addEventListener('click', async function () {
    const prId = this.getAttribute('data-pr-id');
    const status = this.getAttribute('data-status');
    const hasPOs = this.getAttribute('data-has-pos') === '1';

    // Prevent deletion if there are related POs
    if (hasPOs) {
      alert('Cannot delete this PR because it has related Purchase Orders. Please delete the related POs first.');
      return;
    }

    // If PR is approved, require admin password
    if (status === 'approved') {
      const password = prompt('This PR is approved. Enter your admin password to confirm deletion:');
      if (!password) return;

      // Verify password via API call
      const resp = await fetch('/verify_admin_password', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ password: password })
      });
      const data = await resp.json();
      if (!data.success) {
        alert('Incorrect password. Deletion cancelled.');
        return;
      }
    } else {
      if (!confirm('Are you sure you want to delete this PR?')) return;
    }

    // Proceed with deletion
    fetch(`/pr/delete/${prId}`, { method: 'POST' })
      .then(response => {
        if (response.redirected) {
          window.location.href = response.url;
        }
      });
  });
});
</script>

{% endblock %}
