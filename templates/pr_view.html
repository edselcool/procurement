{% extends 'base.html' %}
{% block title %}PR {{ pr.id }} - Procurement{% endblock %}

{% block content %}
<div class="card">
  <div class="card-body">
    <h3 class="card-title">PR #{{ pr.id }} - {{ pr.title }}</h3>
    <p class="text-muted">
      Status:
      <span class="badge bg-secondary">{{ pr.status }}</span>
    </p>
    <p>Created at: {{ pr.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
    <p>Created by: {{ creator.username if creator else 'Unknown' }}</p>

    <hr>

    <h5>Description</h5>
    <p>{{ pr.description }}</p>
    <a href="{{ url_for('pr_edit', pr_id=pr.id) }}" class="btn btn-warning">Edit PR</a>
    <a href="{{ url_for('pr_print', pr_id=pr.id) }}" class="btn btn-secondary">Print / Download</a>
    {% if pr.status == 'approved' and current_user.role in ('admin', 'approver') %}
      <a href="{{ url_for('po_create', pr_id=pr.id) }}" class="btn btn-sm btn-success">View</a>
    {% endif %}

    <!-- Submit Button (Requester Only, Only if Draft) -->
    {% if current_user.is_authenticated and current_user.role == 'requester' and pr.status == 'draft' %}
      <form method="post" action="{{ url_for('pr_submit', pr_id=pr.id) }}" class="mt-3 mb-3">
        <button type="submit" class="btn btn-success">Submit PR</button>
      </form>
    {% endif %}

    <!-- Approval Buttons (Approver/Admin Only) -->
    {% if current_user.is_authenticated and current_user.role in ('approver','admin') and pr.status == 'pending' %}
      <form method="post" action="{{ url_for('pr_approve', pr_id=pr.id) }}" class="mt-3 mb-3">
        <div class="mb-2">
          <textarea name="comment" class="form-control" placeholder="Add approval/rejection comment"></textarea>
        </div>
        <button name="action" value="approve" class="btn btn-success">Approve</button>
        <button name="action" value="reject" class="btn btn-danger">Reject</button>
      </form>
    {% endif %}

    <hr>

    <!-- Line Items Section -->
    {% if line_items %}
      <h4>Line Items</h4>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Item Name</th>
            <th>Quantity</th>
            <th>Unit</th>
            <th>Unit Price</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody>
          {% for item in line_items %}
            <tr>
              <td>{{ item.item_name }}</td>
              <td>{{ item.quantity }}</td>
              <td>{{ item.unit }}</td>
              <td>{{ item.unit_price }}</td>
              <td>{{ item.subtotal }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <p><strong>Total:</strong> {{ pr.total }}</p>
    {% else %}
      <p>No items added.</p>
    {% endif %}

  </div>
</div>
{% endblock %}
