{% extends 'base.html' %}
{% block title %}Balance for PR #{{ pr.id }}{% endblock %}

{% block content %}
<div class="card">
  <div class="card-body">
    <h3 class="card-title mb-3">Balance Details for PR #{{ pr.id }} - {{ pr.title }}</h3>

    <p><strong>PR Created By:</strong> {{ creator.username if creator else 'Unknown' }}</p>
    <p><strong>Status:</strong> {{ pr.status }}</p>
    <p><strong>Created At:</strong> {{ pr.created_at.strftime('%Y-%m-%d %H:%M') }}</p>

    <hr>

    <h4>Line Items</h4>

    {% set ns = namespace(pr_total=0) %}
    {% if line_items %}
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Item Name</th>
            <th class="text-end">Quantity</th>
            <th>Unit</th>
            <th class="text-end">Unit Price</th>
            <th class="text-end">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          {% for li in line_items %}
            {% set line_subtotal = (li.quantity or 0) * (li.unit_price or 0) %}
            {% set ns.pr_total = ns.pr_total + line_subtotal %}
            <tr>
              <td>{{ li.item_name }}</td>
              <td class="text-end">{{ li.quantity }}</td>
              <td>{{ li.unit }}</td>
              <td class="text-end">{{ '%.2f'|format(li.unit_price or 0) }}</td>
              <td class="text-end">{{ '%.2f'|format(line_subtotal) }}</td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="4" class="text-end">PR Total</th>
            <th class="text-end">{{ '%.2f'|format(ns.pr_total) }}</th>
          </tr>
        </tfoot>
      </table>
    {% else %}
      <p>No line items found for this PR.</p>
    {% endif %}

    <hr>

    <h4>Purchase Orders</h4>

    {% set ns2 = namespace(grand_total=0) %}
    {% if po_items %}
      {% set supplier_groups = {} %}
      {% for po in po_items %}
        {% set _ = supplier_groups.setdefault(po.supplier_name or 'Unknown Supplier', []).append(po) %}
      {% endfor %}

      {% for supplier_name, orders in supplier_groups.items() %}
        {% set ns_supplier = namespace(total=0) %}
        <h5 class="mt-3">Supplier: {{ supplier_name }}</h5>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Item Name</th>
              <th>Brand Name</th>
              <th class="text-end">Quotation Price</th>
              <th class="text-end">Quantity</th>
              <th class="text-end">Line Total</th>
            </tr>
          </thead>
          <tbody>
            {% for o in orders %}
              {% set line_qty = (o.item.quantity if o.item else 0) %}
              {% set line_total = (o.quotation_price or 0) * line_qty %}
              {% set ns_supplier.total = ns_supplier.total + line_total %}
              <tr>
                <td>{{ o.item.item_name if o.item else 'N/A' }}</td>
                <td>{{ o.brand_name or '' }}</td>
                <td class="text-end">{{ '%.2f'|format(o.quotation_price or 0) }}</td>
                <td class="text-end">{{ line_qty }}</td>
                <td class="text-end">{{ '%.2f'|format(line_total) }}</td>
              </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr>
              <th colspan="4" class="text-end">Supplier Total</th>
              <th class="text-end">{{ '%.2f'|format(ns_supplier.total) }}</th>
            </tr>
          </tfoot>
        </table>
        {% set ns2.grand_total = ns2.grand_total + ns_supplier.total %}
      {% endfor %}
    {% else %}
      <p>No purchase orders found for this PR.</p>
    {% endif %}

    <hr>
    <h5>Grand Total (All POs): {{ '%.2f'|format(ns2.grand_total) }}</h5>

    <hr>

    <h4>Balance Summary</h4>
    <p><strong>PR Total:</strong> {{ '%.2f'|format(ns.pr_total) }}</p>
    <p><strong>PO Total:</strong> {{ '%.2f'|format(ns2.grand_total) }}</p>
    <p><strong>Balance (PR - PO):</strong> {{ '%.2f'|format(ns.pr_total - ns2.grand_total) }}</p>

    <a href="{{ url_for('index') }}" class="btn btn-secondary mt-3">Back to Dashboard</a>
  </div>
</div>
{% endblock %}
