{% extends 'base.html' %}
{% block title %}View Purchase Order{% endblock %}

{% block content %}
<div class="card">
  <div class="card-body">
    <h3 class="card-title mb-3">Purchase Order #{{ po.id }}</h3>
    <p><strong>PR ID:</strong> {{ po.pr_id }}</p>
    <p><strong>Item ID:</strong> {{ po.item_id }}</p>
    <p><strong>Supplier:</strong> {{ po.supplier_name }}</p>

    <!-- Brand Name -->
    <p>
      <strong>Brand:</strong>
      {% if current_user.role in ['admin', 'approver'] %}
        <span class="text-display">{{ po.brand_name }}</span>
        <input type="text" class="form-control text-input d-none" value="{{ po.brand_name }}">
      {% else %}
        {{ po.brand_name }}
      {% endif %}
    </p>

    <!-- Quotation Price -->
    <p>
      <strong>Quotation Price:</strong>
      {% if current_user.role in ['admin', 'approver'] %}
        <span class="text-display">{{ po.quotation_price }}</span>
        <input type="number" class="form-control text-input d-none" step="0.01" value="{{ po.quotation_price }}">
      {% else %}
        {{ po.quotation_price }}
      {% endif %}
    </p>

    {% if current_user.role in ['admin', 'approver'] %}
      <div class="mt-3">
        <button class="btn btn-primary edit-btn" onclick="enableEdit({{ po.id }})">Edit</button>
        <button class="btn btn-success save-btn d-none" onclick="saveChanges({{ po.id }})">Save</button>
      </div>
    {% endif %}

    <a href="{{ url_for('purchase_orders') }}" class="btn btn-secondary mt-3">Back</a>
  </div>
</div>

{% if current_user.role in ['admin', 'approver'] %}
<script>
function enableEdit(poId) {
  document.querySelectorAll('.text-display').forEach(el => el.classList.add('d-none'));
  document.querySelectorAll('.text-input').forEach(el => el.classList.remove('d-none'));

  document.querySelector('.edit-btn').classList.add('d-none');
  document.querySelector('.save-btn').classList.remove('d-none');
}

function saveChanges(poId) {
  const brandInput = document.querySelector('input[type="text"]');
  const priceInput = document.querySelector('input[type="number"]');

  fetch(`/po/update/${poId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      brand_name: brandInput.value,
      quotation_price: parseFloat(priceInput.value)
    })
  })
  .then(response => {
    if (response.ok) {
      document.querySelector('.text-display').innerText = brandInput.value;
      document.querySelectorAll('.text-display')[1].innerText = priceInput.value;

      document.querySelectorAll('.text-display').forEach(el => el.classList.remove('d-none'));
      document.querySelectorAll('.text-input').forEach(el => el.classList.add('d-none'));

      document.querySelector('.edit-btn').classList.remove('d-none');
      document.querySelector('.save-btn').classList.add('d-none');
    } else {
      alert('Failed to update PO');
    }
  })
  .catch(err => {
    alert('Error saving changes');
    console.error(err);
  });
}
</script>
{% endif %}
{% endblock %}
